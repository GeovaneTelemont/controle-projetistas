{% load static %}
<!-- Tabela de Produção - Mantendo Layout -->
<div class="card border-0 shadow-sm">
    <!-- Cabeçalho do Card com Botões -->
    <div class="card-header border-0" style="background: linear-gradient(135deg, #4361ee, #3a56d4);">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-white">
                <i class="fas fa-industry me-2"></i>Produção
                <small class="ms-2 opacity-75">
                    (Ativos: {{ producoes_pendentes|add:producoes_andamento|add:producoes_revisao }} | 
                    Inativos: {{ producoes_concluidas|add:producoes_canceladas }})
                </small>
            </h5>
            <div>
                <button type="button" 
                        class="btn btn-light btn-sm me-2" 
                        onclick="abrirModalNovoProjeto()"
                        style="border-radius: 8px;">
                    <i class="fas fa-plus-circle me-2"></i>Inserir Novo Projeto
                </button>
                {% if producoes_concluidas|add:producoes_canceladas > 0 %}
                <!-- <a href="#inativos" class="btn btn-outline-light btn-sm" data-bs-toggle="tab">
                    <i class="fas fa-archive me-2"></i>Ver Todos Inativos
                </a> -->
                {% endif %}
            </div>
        </div>
        
        <!-- NOVO: Filtros e Pesquisa -->
        <div class="row mt-3 g-2">
            <div class="col-md-4">
                <!-- Filtro por Status -->
                <div class="btn-group w-100" role="group" aria-label="Filtrar por status">
                    <button type="button" class="btn btn-outline-light active" id="filtroTodos" onclick="filtrarTabela('todos')">
                        Todos
                    </button>
                    <button type="button" class="btn btn-outline-light" id="filtroAtivos" onclick="filtrarTabela('ativos')">
                        Ativos
                    </button>
                    <button type="button" class="btn btn-outline-light" id="filtroInativos" onclick="filtrarTabela('inativos')">
                        Inativos
                    </button>
                </div>
            </div>
            <div class="col-md-8">
                <!-- Pesquisa por DC/ID -->
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="fas fa-search text-primary"></i>
                    </span>
                    <input type="text" 
                           class="form-control border-start-0" 
                           id="pesquisaDCID" 
                           placeholder="Pesquisar por DC/ID..."
                           onkeyup="pesquisarDCID()">
                    <button class="btn btn-light" type="button" onclick="limparPesquisa()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <small class="text-white mt-1 d-block">Pesquisar por DC/ID</small>
            </div>
        </div>
    </div>
    
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="tabelaProducaoPrincipal">
                <thead style="background-color: #f8f9fa;">
                    <tr>
                        <th class="border-0" style="width: 15%;">DC/ID</th>
                        <th class="border-0" style="width: 10%;">Data</th>
                        <th class="border-0" style="width: 15%;">Tipo</th>
                        <th class="border-0" style="width: 12%;">Categoria</th>
                        <th class="border-0" style="width: 10%;">Metragem</th>
                        <th class="border-0" style="width: 12%;">Status</th>
                        <th class="border-0 text-center" style="width: 20%;">Ações</th>
                    </tr>
                </thead>
                <tbody id="tabelaProducao">
                    {% if producoes %}
                        {% for producao in producoes %}
                        <tr class="border-bottom {% if producao.status == 'CONCLUIDO' or producao.status == 'CANCELADO' %}table-inactive{% endif %}" 
                            style="cursor: pointer;"
                            data-status="{{ producao.status }}"
                            data-estado="{% if producao.status == 'PENDENTE' or producao.status == 'EM_ANDAMENTO' or producao.status == 'REVISAO' %}ativo{% else %}inativo{% endif %}"
                            data-id="{{ producao.id }}"
                            data-dcid="{{ producao.dc_id|lower }}">
                            
                            <!-- DC/ID - Click para editar -->
                            <td data-bs-toggle="modal" data-bs-target="#editarDCIDModal{{ producao.id }}">
                                <span class="badge bg-light text-dark border" style="font-size: 0.85rem;">
                                    <i class="fas fa-hashtag me-1"></i>{{ producao.dc_id }}
                                </span>
                            </td>
                            
                            <!-- Data - APENAS VISUALIZAÇÃO (não clicável) -->
                            <td style="cursor: default;">
                                <div class="d-flex align-items-center">
                                    <i class="far fa-calendar text-primary me-2"></i>
                                    <span>{{ producao.data|date:"d/m/Y" }}</span>
                                </div>
                            </td>
                            
                            <!-- Tipo - Click para editar -->
                            <td data-bs-toggle="modal" data-bs-target="#editarTipoModal{{ producao.id }}">
                                <div class="d-flex align-items-center">
                                    {% if producao.tipo_projeto.nome == "Instalação" %}
                                    <i class="fas fa-wrench text-primary me-2"></i>
                                    {% elif producao.tipo_projeto.nome == "Manutenção" %}
                                    <i class="fas fa-tools text-warning me-2"></i>
                                    {% elif producao.tipo_projeto.nome == "Expansão" %}
                                    <i class="fas fa-expand-arrows-alt text-success me-2"></i>
                                    {% else %}
                                    <i class="fas fa-project-diagram text-info me-2"></i>
                                    {% endif %}
                                    <span>{{ producao.tipo_projeto.nome }}</span>
                                </div>
                            </td>
                            
                            <!-- Categoria - Click para editar -->
                            <td data-bs-toggle="modal" data-bs-target="#editarCategoriaModal{{ producao.id }}">
                                <span class="badge bg-light-blue text-dark border" 
                                      style="background-color: #e3f2fd; font-size: 0.8rem;">
                                    {{ producao.categoria.nome }}
                                </span>
                            </td>
                            
                            <!-- Metragem - Click para editar -->
                            <td data-bs-toggle="modal" data-bs-target="#editarMetragemModal{{ producao.id }}">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-ruler-combined text-muted me-2"></i>
                                    <span class="fw-medium">{{ producao.metragem_cabo|default:"0.00" }}m</span>
                                </div>
                            </td>
                            
                            <!-- Status - Click para editar -->
                            <td data-bs-toggle="modal" data-bs-target="#editarStatusModal{{ producao.id }}">
                                {% if producao.status == 'CANCELADO' %}
                                <span class="badge status-badge status-cancelado-inactive" style="font-size: 0.75rem; padding: 0.35em 0.65em;">
                                    <i class="fas fa-times-circle me-1"></i>Cancelado
                                </span>
                                {% elif producao.status == 'PENDENTE' %}
                                <span class="badge status-badge status-pendente" style="font-size: 0.75rem; padding: 0.35em 0.65em;">
                                    <i class="fas fa-clock me-1"></i>Pendente
                                </span>
                                {% elif producao.status == 'EM_ANDAMENTO' %}
                                <span class="badge status-badge status-andamento" style="font-size: 0.75rem; padding: 0.35em 0.65em;">
                                    <i class="fas fa-spinner fa-pulse me-1"></i>Em Andamento
                                </span>
                                {% elif producao.status == 'REVISAO' %}
                                <span class="badge status-badge status-revisao" style="font-size: 0.75rem; padding: 0.35em 0.65em;">
                                    <i class="fas fa-search me-1"></i>Revisão
                                </span>
                                {% elif producao.status == 'CONCLUIDO' %}
                                <span class="badge status-badge status-concluido-inactive" style="font-size: 0.75rem; padding: 0.35em 0.65em;">
                                    <i class="fas fa-check-circle me-1"></i>Concluído
                                </span>
                                {% else %}
                                <span class="badge bg-light text-dark" style="font-size: 0.75rem; padding: 0.35em 0.65em;">
                                    <i class="fas fa-question-circle me-1"></i>{{ producao.status }}
                                </span>
                                {% endif %}
                            </td>
                            
                            <!-- Ações - Não é clicável -->
                            <td class="text-center" style="cursor: default;">
                                <div class="btn-group" role="group" aria-label="Ações">
                                    <!-- Botão Editar Completo -->
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-primary btn-action" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#editarCompletoModal{{ producao.id }}"
                                            title="Editar Completo">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    
                                    <!-- Botão Inativar/Reativar -->
                                    {% if producao.status == 'CONCLUIDO' or producao.status == 'CANCELADO' %}
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-success btn-action" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#reativarModal{{ producao.id }}"
                                            title="Reativar Projeto">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                    {% else %}
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-secondary btn-action" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#inativarModal{{ producao.id }}"
                                            title="Marcar como Inativo">
                                        <i class="fas fa-check-circle"></i>
                                    </button>
                                    {% endif %}
                                    
                                    <!-- Botão Excluir Projeto -->
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-danger btn-action" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#excluirModal{{ producao.id }}"
                                            title="Excluir Projeto Permanentemente">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        
                        <!-- ========== MODAIS PARA EDIÇÃO INDIVIDUAL ========== -->
                        <!-- Modal para editar DC/ID -->
                        <div class="modal fade" id="editarDCIDModal{{ producao.id }}" tabindex="-1">
                            <div class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <form method="post" action="{% url 'producao' %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="producao_id" value="{{ producao.id }}">
                                        
                                        <div class="modal-header bg-primary text-white">
                                            <h6 class="modal-title">
                                                <i class="fas fa-hashtag me-2"></i>Editar DC/ID
                                            </h6>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <label class="form-label">Novo DC/ID</label>
                                                <input type="text" name="dc_id" class="form-control" 
                                                       value="{{ producao.dc_id }}" required>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            <button type="submit" name="editar_dc_id" class="btn btn-sm btn-primary">
                                                <i class="fas fa-save me-1"></i>Salvar
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Modal para editar Tipo -->
                        <div class="modal fade" id="editarTipoModal{{ producao.id }}" tabindex="-1">
                            <div class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <form method="post" action="{% url 'producao' %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="producao_id" value="{{ producao.id }}">
                                        
                                        <div class="modal-header bg-primary text-white">
                                            <h6 class="modal-title">
                                                <i class="fas fa-project-diagram me-2"></i>Editar Tipo
                                            </h6>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <label class="form-label">Novo Tipo</label>
                                                <select name="tipo_projeto" class="form-select" required>
                                                    {% for tipo in tipos_projeto %}
                                                        <option value="{{ tipo.id }}" 
                                                                {% if producao.tipo_projeto.id == tipo.id %}selected{% endif %}>
                                                            {{ tipo.nome }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            <button type="submit" name="editar_tipo" class="btn btn-sm btn-primary">
                                                <i class="fas fa-save me-1"></i>Salvar
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Modal para editar Categoria -->
                        <div class="modal fade" id="editarCategoriaModal{{ producao.id }}" tabindex="-1">
                            <div class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <form method="post" action="{% url 'producao' %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="producao_id" value="{{ producao.id }}">
                                        
                                        <div class="modal-header bg-primary text-white">
                                            <h6 class="modal-title">
                                                <i class="fas fa-tags me-2"></i>Editar Categoria
                                            </h6>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <label class="form-label">Nova Categoria</label>
                                                <select name="categoria" class="form-select" required>
                                                    {% for cat in categorias %}
                                                        <option value="{{ cat.id }}" 
                                                                {% if producao.categoria.id == cat.id %}selected{% endif %}>
                                                            {{ cat.nome }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            <button type="submit" name="editar_categoria" class="btn btn-sm btn-primary">
                                                <i class="fas fa-save me-1"></i>Salvar
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Modal para editar Metragem -->
                        <div class="modal fade" id="editarMetragemModal{{ producao.id }}" tabindex="-1">
                            <div class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <form method="post" action="{% url 'producao' %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="producao_id" value="{{ producao.id }}">
                                        
                                        <div class="modal-header bg-primary text-white">
                                            <h6 class="modal-title">
                                                <i class="fas fa-ruler-combined me-2"></i>Editar Metragem
                                            </h6>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <label class="form-label">Nova Metragem (m)</label>
                                                <input type="number" name="metragem_cabo" class="form-control" 
                                                       step="0.01" min="0" value="{{ producao.metragem_cabo|default:'0.00' }}">
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            <button type="submit" name="editar_metragem" class="btn btn-sm btn-primary">
                                                <i class="fas fa-save me-1"></i>Salvar
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Modal para editar Status (COM NOVA FUNCIONALIDADE) -->
                        <div class="modal fade" id="editarStatusModal{{ producao.id }}" tabindex="-1">
                            <div class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <form method="post" action="{% url 'producao' %}" id="formStatus{{ producao.id }}">
                                        {% csrf_token %}
                                        <input type="hidden" name="producao_id" value="{{ producao.id }}">
                                        
                                        <div class="modal-header bg-primary text-white">
                                            <h6 class="modal-title">
                                                <i class="fas fa-exchange-alt me-2"></i>Alterar Status
                                            </h6>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <label class="form-label">Novo Status</label>
                                                <select name="status" class="form-select" 
                                                        id="statusSelect{{ producao.id }}" 
                                                        onchange="validarMotivoStatus('{{ producao.id }}')" required>
                                                    {% for status_value, status_label in status_choices %}
                                                        <option value="{{ status_value }}" 
                                                                {% if producao.status == status_value %}selected{% endif %}>
                                                            {{ status_label }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Motivo da Alteração 
                                                    <span id="motivoObrigatorio{{ producao.id }}" class="text-danger" style="display: none;">*</span>
                                                    <span id="contadorCaracteres{{ producao.id }}" class="badge bg-light text-dark float-end" style="display: none; font-size: 0.7em;">0/20</span>
                                                </label>
                                                <textarea name="motivo_status" 
                                                          class="form-control" 
                                                          rows="3" 
                                                          id="motivoStatus{{ producao.id }}"
                                                          placeholder="Descreva o motivo da alteração (mínimo 20 caracteres para status Pendente ou Cancelado)..."
                                                          oninput="validarMotivoStatus('{{ producao.id }}')">{{ producao.motivo_status|default:'' }}</textarea>
                                                <div class="form-text" id="motivoHelp{{ producao.id }}">
                                                    Descreva o motivo da alteração de status
                                                </div>
                                                <div class="invalid-feedback" id="motivoFeedback{{ producao.id }}" style="display: none;">
                                                    Para status Cancelado ou Pendente, o motivo deve ter pelo menos 20 caracteres
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            <button type="submit" 
                                                    name="editar_status" 
                                                    class="btn btn-sm btn-primary"
                                                    id="btnSalvarStatus{{ producao.id }}"
                                                    {% if producao.status == "CANCELADO" or producao.status == "PENDENTE" and not producao.motivo_status %}disabled{% endif %}>
                                                <i class="fas fa-save me-1"></i>Salvar
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ========== MODAIS DE AÇÕES ========== -->
                        <!-- Modal para Edição Completa -->
                        <div class="modal fade" id="editarCompletoModal{{ producao.id }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <form method="post" action="{% url 'producao' %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="producao_id" value="{{ producao.id }}">
                                        
                                        <div class="modal-header bg-primary text-white">
                                            <h5 class="modal-title">
                                                <i class="fas fa-edit me-2"></i>Edição Completa
                                            </h5>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <label class="form-label">DC/ID</label>
                                                <input type="text" name="dc_id" class="form-control" 
                                                       value="{{ producao.dc_id }}" required>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Tipo</label>
                                                    <select name="tipo_projeto" class="form-select" required>
                                                        {% for tipo in tipos_projeto %}
                                                            <option value="{{ tipo.id }}" 
                                                                    {% if producao.tipo_projeto.id == tipo.id %}selected{% endif %}>
                                                                {{ tipo.nome }}
                                                            </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Categoria</label>
                                                    <select name="categoria" class="form-select" required>
                                                        {% for cat in categorias %}
                                                            <option value="{{ cat.id }}" 
                                                                    {% if producao.categoria.id == cat.id %}selected{% endif %}>
                                                                {{ cat.nome }}
                                                            </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Metragem (m)</label>
                                                    <input type="number" name="metragem_cabo" class="form-control" 
                                                           step="0.01" min="0" value="{{ producao.metragem_cabo|default:'0.00' }}">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Status</label>
                                                    <select name="status" class="form-select" required>
                                                        {% for status_value, status_label in status_choices %}
                                                            <option value="{{ status_value }}" 
                                                                    {% if producao.status == status_value %}selected{% endif %}>
                                                                {{ status_label }}
                                                            </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Observações</label>
                                                <textarea name="observacoes" class="form-control" rows="3">{{ producao.observacoes|default:'' }}</textarea>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            <button type="submit" name="editar_completo" class="btn btn-primary">
                                                <i class="fas fa-save me-2"></i>Salvar
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Modal para Inativar (Marcar como Inativo) -->
                        <div class="modal fade" id="inativarModal{{ producao.id }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header bg-warning text-dark">
                                        <h5 class="modal-title">
                                            <i class="fas fa-check-circle me-2"></i>Marcar como Inativo
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form method="post" action="{% url 'producao' %}" id="formInativar{{ producao.id }}">
                                        {% csrf_token %}
                                        <input type="hidden" name="producao_id" value="{{ producao.id }}">
                                        
                                        <div class="modal-body">
                                            <div class="alert alert-warning">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                <strong>Atenção!</strong> Esta ação marcará o projeto como inativo (Concluído ou Cancelado).
                                            </div>
                                            <p>Selecione o status:</p>
                                            
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="status_inativar" 
                                                           id="cancelado{{ producao.id }}" value="CANCELADO">
                                                    <label class="form-check-label" for="cancelado{{ producao.id }}">
                                                        <span class="badge status-cancelado">Cancelado</span> - Projeto foi cancelado
                                                    </label>
                                                </div>
                                                <div class="form-check mt-2">
                                                    <input class="form-check-input" type="radio" name="status_inativar" 
                                                           id="concluido{{ producao.id }}" value="CONCLUIDO" checked>
                                                    <label class="form-check-label" for="concluido{{ producao.id }}">
                                                        <span class="badge status-concluido">Concluído</span> - Projeto foi finalizado
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Motivo</label>
                                                <textarea name="motivo_inativar" class="form-control" rows="3" 
                                                          placeholder="Descreva o motivo da conclusão/cancelamento..." required></textarea>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            <button type="submit" name="inativar_producao" class="btn btn-warning">
                                                <i class="fas fa-check-circle me-2"></i>Marcar como Inativo
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Modal para Reativar -->
                        <div class="modal fade" id="reativarModal{{ producao.id }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header bg-success text-white">
                                        <h5 class="modal-title">
                                            <i class="fas fa-redo me-2"></i>Reativar Projeto
                                        </h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form method="post" action="{% url 'producao' %}" id="formReativar{{ producao.id }}">
                                        {% csrf_token %}
                                        <input type="hidden" name="producao_id" value="{{ producao.id }}">
                                        
                                        <div class="modal-body">
                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Esta ação reativará o projeto para status ativo (Pendente, Em Andamento ou Revisão).
                                            </div>
                                            <p>Selecione o novo status:</p>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Novo Status (Ativo)</label>
                                                <select name="status_reativar" class="form-select" required>
                                                    <option value="PENDENTE">Pendente</option>
                                                    <option value="EM_ANDAMENTO" selected>Em Andamento</option>
                                                    <option value="REVISAO">Revisão</option>
                                                </select>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Motivo da Reativação</label>
                                                <textarea name="motivo_reativar" class="form-control" rows="3" 
                                                          placeholder="Descreva o motivo para reativação..." required></textarea>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            <button type="submit" name="reativar_producao" class="btn btn-success">
                                                <i class="fas fa-redo me-2"></i>Reativar Projeto
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Modal para Excluir Projeto Permanentemente -->
                        <div class="modal fade" id="excluirModal{{ producao.id }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header bg-danger text-white">
                                        <h5 class="modal-title">
                                            <i class="fas fa-trash me-2"></i>Excluir Projeto
                                        </h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form method="post" action="{% url 'producao' %}" id="formExcluir{{ producao.id }}" onsubmit="return validarExclusaoFinal('{{ producao.dc_id }}', '{{ producao.id }}')">
                                        {% csrf_token %}
                                        <input type="hidden" name="producao_id" value="{{ producao.id }}">
                                        
                                        <div class="modal-body">
                                            <div class="alert alert-danger">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                <strong>ATENÇÃO: AÇÃO IRREVERSÍVEL!</strong><br>
                                                Esta ação excluirá PERMANENTEMENTE o projeto e todos os seus dados históricos.
                                                Não será possível recuperar os dados após a exclusão.
                                            </div>
                                            
                                            <div class="card mb-3 border-danger">
                                                <div class="card-body">
                                                    <h6 class="card-title">{{ producao.dc_id }}</h6>
                                                    <p class="card-text mb-1">
                                                        <small>
                                                            <strong>Tipo:</strong> {{ producao.tipo_projeto.nome }}<br>
                                                            <strong>Categoria:</strong> {{ producao.categoria.nome }}<br>
                                                            <strong>Status:</strong> 
                                                            {% if producao.status == 'CANCELADO' %}
                                                            <span class="badge status-cancelado">Cancelado</span>
                                                            {% elif producao.status == 'CONCLUIDO' %}
                                                            <span class="badge status-concluido">Concluído</span>
                                                            {% else %}
                                                            <span class="badge bg-secondary">{{ producao.status }}</span>
                                                            {% endif %}
                                                            <br>
                                                            <strong>Início:</strong> {{ producao.data|date:"d/m/Y" }}
                                                        </small>
                                                    </p>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Confirme o DC/ID para exclusão</label>
                                                <input type="text" name="confirmar_dc_id" id="confirmarDCID{{ producao.id }}" 
                                                       class="form-control" 
                                                       placeholder="Digite o DC/ID para confirmar" required
                                                       oninput="validarExclusaoDinamica('{{ producao.dc_id }}', '{{ producao.id }}')">
                                                <div class="form-text">Digite exatamente: <strong id="dcIdTexto{{ producao.id }}">{{ producao.dc_id }}</strong></div>
                                                <div id="feedbackDCID{{ producao.id }}" class="invalid-feedback" style="display: none;">
                                                    O DC/ID digitado não confere com o projeto!
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Motivo da Exclusão</label>
                                                <textarea name="motivo_exclusao" id="motivoExclusao{{ producao.id }}" 
                                                          class="form-control" rows="3" 
                                                          placeholder="Descreva o motivo para exclusão permanente..." 
                                                          required
                                                          oninput="validarExclusaoDinamica('{{ producao.dc_id }}', '{{ producao.id }}')"></textarea>
                                                <div id="feedbackMotivo{{ producao.id }}" class="invalid-feedback" style="display: none;">
                                                    Por favor, descreva o motivo da exclusão.
                                                </div>
                                            </div>
                                            
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="confirmar_exclusao" 
                                                       id="confirmarExclusao{{ producao.id }}" 
                                                       onchange="validarExclusaoDinamica('{{ producao.dc_id }}', '{{ producao.id }}')">
                                                <label class="form-check-label text-danger" for="confirmarExclusao{{ producao.id }}">
                                                    <i class="fas fa-exclamation-circle me-1"></i>
                                                    Confirmo que compreendo que esta ação é irreversível e desejo excluir permanentemente este projeto.
                                                </label>
                                                <div id="feedbackCheckbox{{ producao.id }}" class="invalid-feedback" style="display: none;">
                                                    Você deve confirmar que compreende que esta ação é irreversível.
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            <button type="submit" name="excluir_producao" class="btn btn-danger" 
                                                    id="btnExcluir{{ producao.id }}" disabled>
                                                <i class="fas fa-trash me-2"></i>Excluir Permanentemente
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <tr id="semResultados" style="display: none;">
                        <td colspan="7" class="text-center py-4">
                            <div class="mb-3">
                                <i class="fas fa-search fa-3x text-muted opacity-25"></i>
                            </div>
                            <h5 class="text-muted mb-2">Nenhum resultado encontrado</h5>
                            <p class="text-muted mb-4">Nenhum projeto corresponde aos critérios de pesquisa.</p>
                            <button type="button" class="btn btn-outline-primary" onclick="limparFiltros()">
                                <i class="fas fa-times me-2"></i>Limpar Filtros
                            </button>
                        </td>
                    </tr>
                    
                    <tr id="nenhumaProducao">
                        <td colspan="7" class="text-center py-4">
                            <div class="mb-3">
                                <i class="fas fa-inbox fa-3x text-muted opacity-25"></i>
                            </div>
                            <h5 class="text-muted mb-2">Nenhuma produção encontrada</h5>
                            <p class="text-muted mb-4">Você ainda não possui produções cadastradas.</p>
                            <button type="button" class="btn btn-primary" onclick="abrirModalNovoProjeto()">
                                <i class="fas fa-plus me-2"></i>Adicionar Primeira Produção
                            </button>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        <!-- Indicador visual de ordenação -->
        <div class="card-footer bg-light border-0 py-2">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    <span id="contadorResultados">
                        {% if producoes %}
                            Mostrando <span id="contadorAtivosVisiveis">{{ producoes_pendentes|add:producoes_andamento|add:producoes_revisao }}</span> ativos 
                            | <span id="contadorInativosVisiveis">{{ producoes_concluidas|add:producoes_canceladas }}</span> inativos
                        {% else %}
                            Nenhum resultado
                        {% endif %}
                    </span>
                </small>
                <small class="text-muted">
                    <i class="fas fa-sort me-1"></i>
                    Ordenação: Ativos primeiro → Inativos
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Adicionar Novo Projeto -->
<div class="modal fade" id="adicionarProducaoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'producao' %}">
                {% csrf_token %}
                
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-plus-circle me-2"></i>Novo Projeto
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Status será EM_ANDAMENTO por padrão (Status Ativo) -->
                    <input type="hidden" name="status" value="EM_ANDAMENTO">
                    <!-- Motivo será "Iniciando projeto" por padrão -->
                    <input type="hidden" name="motivo_status" value="Iniciando projeto">
                    <!-- Data será a data atual automaticamente -->
                    <input type="hidden" name="data" value="{% now 'Y-m-d' %}">
                    
                    <div class="mb-3">
                        <label class="form-label">DC/ID do Projeto *</label>
                        <input type="text" name="dc_id" class="form-control" required 
                               placeholder="Ex: DC-2024-001">
                        <div class="form-text">Identificador único do projeto</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Data de Criação</label>
                            <input type="text" class="form-control" 
                                   value="{% now 'd/m/Y' %}" readonly
                                   style="background-color: #f8f9fa; cursor: not-allowed;">
                            <div class="form-text">Data preenchida automaticamente</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tipo de Projeto *</label>
                            <select name="tipo_projeto" class="form-select" required>
                                <option value="">Selecione...</option>
                                {% for tipo in tipos_projeto %}
                                    <option value="{{ tipo.id }}">{{ tipo.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Categoria *</label>
                            <select name="categoria" class="form-select" required>
                                <option value="">Selecione...</option>
                                {% for categoria in categorias %}
                                    <option value="{{ categoria.id }}">{{ categoria.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Metragem de Cabo (m)</label>
                            <input type="number" name="metragem_cabo" class="form-control" 
                                   step="0.01" min="0" value="0.00">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Observações</label>
                        <textarea name="observacoes" class="form-control" rows="3" 
                                  placeholder="Observações sobre a produção..."></textarea>
                    </div>
                    
                    <div class="alert alert-info">
                        <div class="d-flex">
                            <i class="fas fa-info-circle me-2 mt-1"></i>
                            <div>
                                <small>
                                    <strong>Informação:</strong><br>
                                    • Status padrão: <span class="badge status-andamento">EM ANDAMENTO</span> (Status Ativo)<br>
                                    • Motivo padrão: "Iniciando projeto"<br>
                                    • Data: preenchida automaticamente<br>
                                    • Campos marcados com * são obrigatórios.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" name="nova_producao" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Salvar Projeto
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Função para abrir o modal de novo projeto
function abrirModalNovoProjeto() {
    var modal = new bootstrap.Modal(document.getElementById('adicionarProducaoModal'));
    modal.show();
    
    // Focar no primeiro campo após abrir o modal
    setTimeout(function() {
        const input = document.querySelector('#adicionarProducaoModal input[name="dc_id"]');
        if (input) input.focus();
    }, 500);
}

// Variáveis globais para controle de filtros
let filtroAtual = 'todos';
let termoPesquisa = '';

// Função para filtrar tabela por status
function filtrarTabela(tipo) {
    filtroAtual = tipo;
    
    // Atualizar botões ativos
    const botaoTodos = document.getElementById('filtroTodos');
    const botaoAtivos = document.getElementById('filtroAtivos');
    const botaoInativos = document.getElementById('filtroInativos');
    
    if (botaoTodos) botaoTodos.classList.remove('active');
    if (botaoAtivos) botaoAtivos.classList.remove('active');
    if (botaoInativos) botaoInativos.classList.remove('active');
    
    const botaoAtual = document.getElementById('filtro' + tipo.charAt(0).toUpperCase() + tipo.slice(1));
    if (botaoAtual) botaoAtual.classList.add('active');
    
    // Aplicar filtros
    aplicarFiltros();
}

// Função para pesquisar por DC/ID
function pesquisarDCID() {
    const input = document.getElementById('pesquisaDCID');
    if (input) {
        termoPesquisa = input.value.trim().toLowerCase();
        aplicarFiltros();
    }
}

// Função para limpar pesquisa
function limparPesquisa() {
    const input = document.getElementById('pesquisaDCID');
    if (input) {
        input.value = '';
        termoPesquisa = '';
        aplicarFiltros();
    }
}

// Função para limpar todos os filtros
function limparFiltros() {
    const input = document.getElementById('pesquisaDCID');
    if (input) {
        input.value = '';
    }
    termoPesquisa = '';
    filtroAtual = 'todos';
    
    // Resetar botões de filtro
    const botaoTodos = document.getElementById('filtroTodos');
    const botaoAtivos = document.getElementById('filtroAtivos');
    const botaoInativos = document.getElementById('filtroInativos');
    
    if (botaoTodos) botaoTodos.classList.add('active');
    if (botaoAtivos) botaoAtivos.classList.remove('active');
    if (botaoInativos) botaoInativos.classList.remove('active');
    
    aplicarFiltros();
}

// Função para verificar se um status é ativo
function isStatusAtivo(status) {
    const statusAtivos = ['PENDENTE', 'EM_ANDAMENTO', 'REVISAO'];
    return statusAtivos.includes(status);
}

// Função principal para aplicar filtros
function aplicarFiltros() {
    const linhas = document.querySelectorAll('#tabelaProducao tr[data-status]');
    const semResultados = document.getElementById('semResultados');
    const nenhumaProducao = document.getElementById('nenhumaProducao');
    const contadorResultados = document.getElementById('contadorResultados');
    const contadorAtivos = document.getElementById('contadorAtivosVisiveis');
    const contadorInativos = document.getElementById('contadorInativosVisiveis');
    
    let totalVisiveis = 0;
    let ativosVisiveis = 0;
    let inativosVisiveis = 0;
    
    // Verificar se há linhas para filtrar
    if (linhas.length === 0) {
        if (semResultados) semResultados.style.display = 'none';
        if (nenhumaProducao) nenhumaProducao.style.display = 'table-row';
        if (contadorResultados) contadorResultados.innerHTML = 'Nenhum resultado';
        return;
    }
    
    // Esconder mensagem de nenhuma produção se existir
    if (nenhumaProducao) nenhumaProducao.style.display = 'none';
    
    linhas.forEach(linha => {
        const status = linha.getAttribute('data-status');
        const estado = linha.getAttribute('data-estado'); // 'ativo' ou 'inativo'
        const dcId = linha.getAttribute('data-dcid');
        
        let mostrar = true;
        
        // Aplicar filtro de status (ativo/inativo)
        if (filtroAtual === 'ativos' && estado !== 'ativo') mostrar = false;
        if (filtroAtual === 'inativos' && estado !== 'inativo') mostrar = false;
        
        // Aplicar filtro de pesquisa
        if (mostrar && termoPesquisa && dcId && !dcId.includes(termoPesquisa)) {
            mostrar = false;
        }
        
        // Mostrar/ocultar linha
        if (mostrar) {
            linha.style.display = '';
            totalVisiveis++;
            
            if (estado === 'ativo') {
                ativosVisiveis++;
            } else {
                inativosVisiveis++;
            }
        } else {
            linha.style.display = 'none';
        }
    });
    
    // Mostrar mensagem se não houver resultados
    if (semResultados) {
        if (totalVisiveis === 0) {
            semResultados.style.display = 'table-row';
            if (contadorResultados) contadorResultados.innerHTML = 'Nenhum resultado';
        } else {
            semResultados.style.display = 'none';
        }
    }
    
    // Atualizar contadores
    if (contadorResultados) {
        if (totalVisiveis === 0) {
            contadorResultados.innerHTML = 'Nenhum resultado';
        } else {
            contadorResultados.innerHTML = 
                `Mostrando ${ativosVisiveis} ativos | ${inativosVisiveis} inativos`;
        }
    }
    
    if (contadorAtivos) contadorAtivos.textContent = ativosVisiveis;
    if (contadorInativos) contadorInativos.textContent = inativosVisiveis;
}

// Função para validar exclusão dinamicamente
function validarExclusaoDinamica(dcIdCorreto, producaoId) {
    const dcIdInput = document.getElementById('confirmarDCID' + producaoId);
    const motivoInput = document.getElementById('motivoExclusao' + producaoId);
    const checkbox = document.getElementById('confirmarExclusao' + producaoId);
    const btnExcluir = document.getElementById('btnExcluir' + producaoId);
    
    if (!dcIdInput || !motivoInput || !checkbox || !btnExcluir) return false;
    
    const dcIdDigitado = dcIdInput.value.trim();
    const motivo = motivoInput.value.trim();
    const checkboxMarcado = checkbox.checked;
    
    // Validar DC/ID
    const dcIdValido = dcIdDigitado === dcIdCorreto;
    const dcIdFeedback = document.getElementById('feedbackDCID' + producaoId);
    
    if (dcIdDigitado && !dcIdValido) {
        dcIdInput.classList.add('is-invalid');
        if (dcIdFeedback) dcIdFeedback.style.display = 'block';
    } else if (dcIdValido) {
        dcIdInput.classList.remove('is-invalid');
        dcIdInput.classList.add('is-valid');
        if (dcIdFeedback) dcIdFeedback.style.display = 'none';
    } else {
        dcIdInput.classList.remove('is-invalid', 'is-valid');
        if (dcIdFeedback) dcIdFeedback.style.display = 'none';
    }
    
    // Validar motivo
    const motivoValido = motivo.length > 0;
    const motivoFeedback = document.getElementById('feedbackMotivo' + producaoId);
    
    if (motivo && !motivoValido) {
        motivoInput.classList.add('is-invalid');
        if (motivoFeedback) motivoFeedback.style.display = 'block';
    } else if (motivoValido) {
        motivoInput.classList.remove('is-invalid');
        motivoInput.classList.add('is-valid');
        if (motivoFeedback) motivoFeedback.style.display = 'none';
    } else {
        motivoInput.classList.remove('is-invalid', 'is-valid');
        if (motivoFeedback) motivoFeedback.style.display = 'none';
    }
    
    // Validar checkbox
    const checkboxFeedback = document.getElementById('feedbackCheckbox' + producaoId);
    
    if (!checkboxMarcado) {
        checkbox.classList.add('is-invalid');
        if (checkboxFeedback) checkboxFeedback.style.display = 'block';
    } else {
        checkbox.classList.remove('is-invalid');
        if (checkboxFeedback) checkboxFeedback.style.display = 'none';
    }
    
    // Habilitar/desabilitar botão
    const todosValidos = dcIdValido && motivoValido && checkboxMarcado;
    
    if (todosValidos) {
        btnExcluir.disabled = false;
        btnExcluir.classList.remove('disabled');
    } else {
        btnExcluir.disabled = true;
        btnExcluir.classList.add('disabled');
    }
    
    return todosValidos;
}

// Função para validação final no submit
function validarExclusaoFinal(dcIdCorreto, producaoId) {
    const valido = validarExclusaoDinamica(dcIdCorreto, producaoId);
    
    if (!valido) {
        // Mostrar todos os feedbacks
        ['feedbackDCID', 'feedbackMotivo', 'feedbackCheckbox'].forEach(feedback => {
            const element = document.getElementById(feedback + producaoId);
            if (element) element.style.display = 'block';
        });
        
        // Focar no primeiro campo com erro
        const dcIdInput = document.getElementById('confirmarDCID' + producaoId);
        if (dcIdInput && !dcIdInput.value) {
            dcIdInput.focus();
        }
    }
    
    return valido;
}

// ========== NOVAS FUNÇÕES PARA VALIDAÇÃO DO MOTIVO DE STATUS ==========

// Função para validar motivo de status e controlar botão
function validarMotivoStatus(producaoId) {
    const statusSelect = document.getElementById('statusSelect' + producaoId);
    const motivoTextarea = document.getElementById('motivoStatus' + producaoId);
    const motivoObrigatorio = document.getElementById('motivoObrigatorio' + producaoId);
    const contadorCaracteres = document.getElementById('contadorCaracteres' + producaoId);
    const motivoFeedback = document.getElementById('motivoFeedback' + producaoId);
    const motivoHelp = document.getElementById('motivoHelp' + producaoId);
    const btnSalvar = document.getElementById('btnSalvarStatus' + producaoId);
    
    if (!statusSelect || !motivoTextarea || !btnSalvar) return;
    
    const status = statusSelect.value;
    const motivo = motivoTextarea.value.trim();
    const contagemCaracteres = motivo.length;
    
    // Status que exigem motivo obrigatório
    const statusObrigatorios = ['CANCELADO', 'PENDENTE'];
    const exigeMotivo = statusObrigatorios.includes(status);
    const minimoCaracteres = 20;
    
    if (exigeMotivo) {
        // Mostrar indicação de obrigatório
        if (motivoObrigatorio) motivoObrigatorio.style.display = 'inline';
        
        // Mostrar contador de caracteres
        if (contadorCaracteres) {
            contadorCaracteres.style.display = 'inline-block';
            contadorCaracteres.textContent = contagemCaracteres + '/' + minimoCaracteres;
            
            // Atualizar cor do contador
            if (contagemCaracteres >= minimoCaracteres) {
                contadorCaracteres.classList.remove('bg-light', 'text-dark');
                contadorCaracteres.classList.add('bg-success', 'text-white');
            } else {
                contadorCaracteres.classList.remove('bg-success', 'text-white');
                contadorCaracteres.classList.add('bg-light', 'text-dark');
            }
        }
        
        // Atualizar texto de ajuda
        if (motivoHelp) {
            motivoHelp.innerHTML = `Este status <strong>exige</strong> o preenchimento do motivo com pelo menos ${minimoCaracteres} caracteres`;
            motivoHelp.className = 'form-text text-danger';
        }
        
        // Validar se motivo tem mínimo de caracteres
        if (contagemCaracteres < minimoCaracteres) {
            motivoTextarea.classList.add('is-invalid');
            motivoTextarea.classList.remove('is-valid');
            if (motivoFeedback) motivoFeedback.style.display = 'block';
            btnSalvar.disabled = true;
            btnSalvar.classList.add('disabled');
            return false;
        } else {
            motivoTextarea.classList.remove('is-invalid');
            motivoTextarea.classList.add('is-valid');
            if (motivoFeedback) motivoFeedback.style.display = 'none';
            btnSalvar.disabled = false;
            btnSalvar.classList.remove('disabled');
            return true;
        }
    } else {
        // Para outros status, motivo é opcional
        if (motivoObrigatorio) motivoObrigatorio.style.display = 'none';
        
        // Esconder contador de caracteres
        if (contadorCaracteres) contadorCaracteres.style.display = 'none';
        
        // Restaurar texto de ajuda padrão
        if (motivoHelp) {
            motivoHelp.innerHTML = 'Descreva o motivo da alteração de status (opcional)';
            motivoHelp.className = 'form-text';
        }
        
        // Limpar validação
        motivoTextarea.classList.remove('is-invalid', 'is-valid');
        if (motivoFeedback) motivoFeedback.style.display = 'none';
        
        // Botão sempre habilitado para outros status
        btnSalvar.disabled = false;
        btnSalvar.classList.remove('disabled');
        
        // Se for CONCLUÍDO e motivo estiver em branco, limpar o campo
        if (status === 'CONCLUIDO' && motivo === '') {
            motivoTextarea.value = '';
        }
        
        return true;
    }
}

// Função para configurar modal de status
function configurarModalStatus(producaoId) {
    const modal = document.getElementById('editarStatusModal' + producaoId);
    if (modal) {
        modal.addEventListener('shown.bs.modal', function() {
            // Validar imediatamente quando o modal abrir
            setTimeout(() => {
                validarMotivoStatus(producaoId);
            }, 100);
        });
        
        // Limpar validação quando modal for fechado
        modal.addEventListener('hidden.bs.modal', function() {
            const motivoTextarea = document.getElementById('motivoStatus' + producaoId);
            const motivoFeedback = document.getElementById('motivoFeedback' + producaoId);
            const motivoHelp = document.getElementById('motivoHelp' + producaoId);
            const motivoObrigatorio = document.getElementById('motivoObrigatorio' + producaoId);
            const contadorCaracteres = document.getElementById('contadorCaracteres' + producaoId);
            const btnSalvar = document.getElementById('btnSalvarStatus' + producaoId);
            
            if (motivoTextarea) {
                motivoTextarea.classList.remove('is-invalid', 'is-valid');
            }
            if (motivoFeedback) motivoFeedback.style.display = 'none';
            if (motivoHelp) {
                motivoHelp.innerHTML = 'Descreva o motivo da alteração de status';
                motivoHelp.className = 'form-text';
            }
            if (motivoObrigatorio) motivoObrigatorio.style.display = 'none';
            if (contadorCaracteres) contadorCaracteres.style.display = 'none';
            
            // Não remover disabled aqui - será validado novamente quando abrir
        });
        
        // Validar antes do submit
        const form = document.getElementById('formStatus' + producaoId);
        if (form) {
            form.addEventListener('submit', function(e) {
                if (!validarMotivoStatus(producaoId)) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Focar no campo de motivo
                    const motivoTextarea = document.getElementById('motivoStatus' + producaoId);
                    if (motivoTextarea) {
                        motivoTextarea.focus();
                    }
                    
                    return false;
                }
                return true;
            });
        }
    }
}

// ========== FIM DAS NOVAS FUNÇÕES ==========

// Inicializar quando o DOM estiver carregado
document.addEventListener('DOMContentLoaded', function() {
    // Adicionar tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Inicializar filtros
    aplicarFiltros();
    
    // Adicionar evento de submit para formulários de reativação/inativação
    document.querySelectorAll('form[id^="formReativar"], form[id^="formInativar"]').forEach(form => {
        form.addEventListener('submit', function() {
            sessionStorage.setItem('atualizarTabela', 'true');
        });
    });
    
    // Verificar se precisa atualizar a tabela após redirecionamento
    if (sessionStorage.getItem('atualizarTabela') === 'true') {
        sessionStorage.removeItem('atualizarTabela');
        setTimeout(() => {
            window.location.reload();
        }, 100);
    }
    
    // Permitir pesquisa com Enter
    const pesquisaInput = document.getElementById('pesquisaDCID');
    if (pesquisaInput) {
        pesquisaInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                pesquisarDCID();
            }
        });
    }
    
    // Configurar modais de exclusão
    {% for producao in producoes %}
    (function() {
        const modal = document.getElementById('excluirModal{{ producao.id }}');
        if (modal) {
            // Limpar validação quando modal for fechado
            modal.addEventListener('hidden.bs.modal', function() {
                const dcIdInput = document.getElementById('confirmarDCID{{ producao.id }}');
                const motivoInput = document.getElementById('motivoExclusao{{ producao.id }}');
                const checkbox = document.getElementById('confirmarExclusao{{ producao.id }}');
                const btnExcluir = document.getElementById('btnExcluir{{ producao.id }}');
                
                if (dcIdInput) dcIdInput.value = '';
                if (motivoInput) motivoInput.value = '';
                if (checkbox) checkbox.checked = false;
                if (btnExcluir) {
                    btnExcluir.disabled = true;
                    btnExcluir.classList.add('disabled');
                }
                
                // Limpar classes de validação
                [dcIdInput, motivoInput, checkbox].forEach(input => {
                    if (input) {
                        input.classList.remove('is-valid', 'is-invalid');
                    }
                });
                
                // Ocultar feedbacks
                ['feedbackDCID', 'feedbackMotivo', 'feedbackCheckbox'].forEach(feedback => {
                    const element = document.getElementById(feedback + '{{ producao.id }}');
                    if (element) element.style.display = 'none';
                });
            });
            
            // Validar quando modal é aberto
            modal.addEventListener('shown.bs.modal', function() {
                setTimeout(() => {
                    validarExclusaoDinamica('{{ producao.dc_id }}', '{{ producao.id }}');
                }, 100);
            });
        }
        
        // Configurar modais de status (NOVO)
        configurarModalStatus('{{ producao.id }}');
    })();
    {% endfor %}
});

// Atualizar contadores (se necessário)
function atualizarContadores() {
    // Esta função pode ser chamada após operações que alterem a tabela
    aplicarFiltros();
}
</script>